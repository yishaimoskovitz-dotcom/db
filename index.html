<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovMap Automation Dashboard</title>
    <style>
        :root { --primary: #0044cc; --success: #28a745; --bg: #f4f6f9; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 300px; background: white; padding: 20px; border-left: 1px solid #ddd; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .step { padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.95rem; border: 1px solid #eee; position: relative; }
        .step-num { position: absolute; top: -10px; right: -10px; background: var(--primary); color: white; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; }
        .step strong { display: block; margin-bottom: 5px; color: #333; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        
        /* ×›×¤×ª×•×¨ ×”×‘×•×˜ - ××©×•×¤×¨ */
        #bookmarklet-link {
            display: block;
            background: #6f42c1;
            color: white;
            text-decoration: none;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            font-weight: bold;
            border: 2px dashed #bba1ea;
            cursor: grab;
            margin-top: 10px;
        }
        #bookmarklet-link:active { cursor: grabbing; }

        table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; }
        .status-done { color: var(--success); font-weight: bold; }
        
        #connection-status { 
            position: fixed; bottom: 20px; left: 20px; 
            background: #dc3545; color: white; 
            padding: 10px 20px; border-radius: 30px; 
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .action-btn { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-open { background: var(--success); color: white; }
        .btn-check { background: var(--warning); color: #333; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>ğŸ“˜ ××“×¨×™×š ×”×¤×¢×œ×” (×—×•×‘×” ×œ×§×¨×•×)</h3>
        
        <div class="step">
            <div class="step-num">1</div>
            <strong>×’×¨×™×¨×ª ×”×‘×•×˜ (×—×“ ×¤×¢××™)</strong>
            ×’×¨×•×¨ ××ª ×”×›×¤×ª×•×¨ ×”×¡×’×•×œ ×”×–×” ×œ×¡×¨×’×œ ×”×¡×™×× ×™×•×ª ×œ××¢×œ×” ×‘×“×¤×“×¤×Ÿ:
            <a id="bookmarklet-link" href="#" onclick="alert('×œ× ×œ×œ×—×•×¥! ×¦×¨×™×š ×œ×’×¨×•×¨ ××ª ×–×” ×œ×¡×¨×’×œ ×œ××¢×œ×” ğŸ‘†'); return false;">
                ğŸ¤– ×‘×•×˜ GovMap v2.0
            </a>
        </div>

        <div class="step">
            <div class="step-num">2</div>
            <strong>×¤×ª×™×—×” ×•×”×’×“×¨×•×ª</strong>
            <button class="action-btn btn-open" onclick="openGovMapWindow()">ğŸŒ ×¤×ª×— ×—×œ×•×Ÿ GovMap</button>
            <p style="font-size:0.85rem; margin-top:5px; color:#555;">
                ×‘×—×œ×•×Ÿ ×©× ×¤×ª×—: <br>
                1. ×ª×“×œ×™×§ ××ª ×›×œ ×”×©×›×‘×•×ª ×©××ª×” ×¦×¨×™×š.<br>
                2. ×ª×œ×—×¥ ×¢×œ ×”×‘×•×˜ ×”×¡×’×•×œ ×©×’×¨×¨×ª ×œ××•×¢×“×¤×™×.
            </p>
        </div>

        <div class="step">
            <div class="step-num">3</div>
            <strong>×‘×“×™×§×ª ×§×©×¨</strong>
            ×—×–×•×¨ ×œ×¤×”. ×× ×”×‘×•×˜ ×¢×•×‘×“, ××ª×” ×ª×¨××” ×œ××˜×” ×¡×™××•×Ÿ ×™×¨×•×§ "××—×•×‘×¨".
            <button class="action-btn btn-check" onclick="testConnection()">ğŸ“¡ ×©×œ×— ×‘×“×™×§×ª ×ª×§×©×•×¨×ª</button>
        </div>
    </div>

    <div class="main-content">
        <h1>××¢×¨×›×ª ××•×˜×•××¦×™×” GovMap</h1>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label style="font-weight:bold;">×”×–×Ÿ ×¨×©×™××ª ×›×ª×•×‘×•×ª (×¨×—×•×‘, ××¡×¤×¨, ×¢×™×¨):</label>
            <textarea id="addressInput" style="width:100%; height:100px; margin:10px 0; padding:10px; border:1px solid #ccc;" placeholder="×”×¨×¦×œ, 15, ×ª×œ ××‘×™×‘&#10;×–'×‘×•×˜×™× ×¡×§×™, 2, ×¨××ª ×’×Ÿ"></textarea>
            <button onclick="loadAddresses()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">×˜×¢×Ÿ ×›×ª×•×‘×•×ª ×œ×˜×‘×œ×”</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr><th>#</th><th>×›×ª×•×‘×ª</th><th>×¡×˜×˜×•×¡</th><th>××™×“×¢ ×©× ×©×œ×£</th><th>×¤×¢×•×œ×”</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <br>
        <button id="exportBtn" onclick="exportToCSV()" style="background:#17a2b8; color:white; border:none; padding:10px 20px; display:none; border-radius:4px; cursor:pointer;">×”×•×¨×“ ××§×¡×œ / CSV</button>
    </div>

    <div id="connection-status">ğŸ”´ ×× ×•×ª×§ - ×‘×¦×¢ ××ª ×©×œ×‘ 2</div>

    <script>
        // --- ×§×•×“ ×”×‘×•×˜ ×”××©×•×¤×¨ (××•×–×¨×§ ×œ××¤×”) ---
        const botCode = `
            (function(){
                // 1. ×‘×“×™×§×” ×©×× ×—× ×• ×‘-GovMap
                if(location.hostname.indexOf('govmap') === -1) { 
                    alert('âŒ ×©×’×™××”: ×”×‘×•×˜ ×”×–×” ×¢×•×‘×“ ×¨×§ ×‘××ª×¨ GovMap!'); return; 
                }

                // 2. ×‘×“×™×§×” ×©×™×© ××‘× (×”××ª×¨ ×©×œ×š)
                if(!window.opener) { 
                    alert('âŒ ×©×’×™××”: × ×•×ª×§ ×”×§×©×¨ ×¢× ×”×“××©×‘×•×¨×“. ×™×© ×œ×¡×’×•×¨ ×•×œ×¤×ª×•×— ××—×“×© ×“×¨×š ×”××ª×¨.'); return; 
                }
                
                // ×”×•×“×¢×ª ×”×¦×œ×—×” ×¨××©×•× ×™×ª
                alert('âœ… ×”×‘×•×˜ ×—×•×‘×¨! \\n×¢×›×©×™×• ×ª×•×•×“× ×©×”×©×›×‘×•×ª ×“×œ×•×§×•×ª ×•××– ×ª×—×–×•×¨ ×œ××ª×¨.');
                window.opener.postMessage({type: 'BOT_CONNECTED'}, '*');

                // 3. ×”××–× ×” ×œ×¤×§×•×“×•×ª
                window.addEventListener('message', function(e) {
                    console.log('Bot received:', e.data);
                    
                    // ×‘×“×™×§×ª ×ª×§×©×•×¨×ª
                    if(e.data.type === 'PING') {
                        alert('ğŸ“¡ ×‘×“×™×§×ª ×ª×§×©×•×¨×ª ×¢×‘×¨×” ×‘×”×¦×œ×—×”! ××¤×©×¨ ×œ×”×ª×—×™×œ ×œ×¢×‘×•×“.');
                        return;
                    }

                    // ×¤×§×•×“×ª ×—×™×¤×•×©
                    if(e.data.type === 'SEARCH_ADDRESS') {
                        const address = e.data.text;
                        
                        // × ×™×¡×™×•×Ÿ ×œ××¦×•× ××ª ×©×•×¨×ª ×”×—×™×¤×•×© ×‘×›××” ×“×¨×›×™×
                        const input = document.getElementById('txtSearch') || 
                                      document.querySelector('input[placeholder*="×›×ª×•×‘×ª"]') ||
                                      document.querySelector('.search-input');
                        
                        const btn = document.querySelector('#btnSearch') || 
                                    document.querySelector('.search-btn');
                        
                        if(input && btn) {
                            // ×”×–× ×” ××’×¨×¡×™×‘×™×ª
                            input.value = address;
                            input.focus();
                            input.dispatchEvent(new Event('input', {bubbles:true}));
                            input.dispatchEvent(new Event('change', {bubbles:true}));
                            
                            // ×œ×—×™×¦×”
                            setTimeout(() => {
                                btn.click();
                                console.log('Searching for:', address);
                            }, 500);
                        } else {
                            alert('âŒ ×”×‘×•×˜ ×œ× ××¦× ××ª ×©×•×¨×ª ×”×—×™×¤×•×©. ×”×× ×”××ª×¨ ×”×©×ª× ×”?');
                        }
                    }
                });

                // 4. ×©××™×‘×ª ××™×“×¢ ××”×‘×•×¢×”
                const observer = new MutationObserver(() => {
                    const popup = document.querySelector('.esri-popup__content');
                    if(popup && popup.innerText.length > 5 && !popup.dataset.scraped) {
                        popup.dataset.scraped = "true";
                        const cleanText = popup.innerText.replace(/\\s+/g, ' ').trim();
                        
                        // ×©×œ×™×—×”
                        window.opener.postMessage({type: 'DATA_EXTRACTED', payload: cleanText}, '*');
                        
                        // ×—×™×•×•×™
                        const badge = document.createElement('div');
                        badge.innerText = 'âœ… × ×©×œ×—!';
                        badge.style.cssText = 'position:fixed; top:100px; right:20px; background:#28a745; color:white; padding:15px; z-index:99999; border-radius:8px; font-weight:bold; font-size:18px; box-shadow:0 4px 15px rgba(0,0,0,0.3);';
                        document.body.appendChild(badge);
                        setTimeout(() => badge.remove(), 2000);
                    }
                });
                observer.observe(document.body, {childList: true, subtree: true});

            })();
        `;
        
        // ×™×¦×™×¨×ª ×”×§×™×©×•×¨ ×œ×’×¨×™×¨×”
        document.getElementById('bookmarklet-link').href = 'javascript:' + encodeURIComponent(botCode);

        // --- ×œ×•×’×™×§×” ×©×œ ×”××ª×¨ ---
        let govMapWindow = null;
        let addresses = [];
        let currentProcessIndex = -1;

        function openGovMapWindow() {
            // ×©×™××•×© ×‘×¤×¨××˜×¨×™× ×›×“×™ ×œ×•×•×“× ×©×”×—×œ×•×Ÿ × ×¤×ª×— ×›×—×œ×•×Ÿ ××©× ×™ ×•×œ× ×›×˜××‘ ×× ×•×ª×§
            govMapWindow = window.open('https://www.govmap.gov.il/?app=dashboard', 'govmap_window');
        }

        function testConnection() {
            if(!govMapWindow || govMapWindow.closed) {
                alert("×”×—×œ×•×Ÿ ×¡×’×•×¨! ×ª×¤×ª×— ××•×ª×• ×§×•×“×.");
                return;
            }
            govMapWindow.postMessage({type: 'PING'}, '*');
        }

        function loadAddresses() {
            const rawText = document.getElementById('addressInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            addresses = [];

            lines.forEach((line, index) => {
                if (!line.includes(',')) { alert(`×©×’×™××” ×‘×©×•×¨×”: ${line}`); return; }
                addresses.push({ id: index, original: line.trim(), data: '', status: 'waiting' });
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `<td>${index + 1}</td><td>${line}</td><td class="status">×××ª×™×Ÿ</td><td class="extracted-data">-</td><td><button class="action-btn" style="background:#007bff; color:white;" onclick="sendToMap(${index})">ğŸ“¡ ×—×¤×©</button></td>`;
                tbody.appendChild(tr);
            });
            if(addresses.length > 0) document.getElementById('exportBtn').style.display = 'inline-block';
        }

        function sendToMap(index) {
            if (!govMapWindow || govMapWindow.closed) {
                alert("GovMap × ×¡×’×¨. ×¤×ª×— ××•×ª×• ××—×“×© ×•×—×‘×¨ ××ª ×”×‘×•×˜.");
                document.getElementById('connection-status').innerText = "ğŸ”´ ×× ×•×ª×§";
                document.getElementById('connection-status').style.background = "#dc3545";
                return;
            }

            currentProcessIndex = index;
            const address = addresses[index].original.replace(/,/g, ' ');

            // UI update
            document.querySelectorAll('tr').forEach(r => r.style.background = 'white');
            const row = document.getElementById(`row-${index}`);
            row.style.backgroundColor = '#fff3cd';
            row.querySelector('.status').innerText = 'â³ × ×©×œ×—...';

            // Send command
            govMapWindow.postMessage({type: 'SEARCH_ADDRESS', text: address}, '*');
        }

        // Listener for incoming messages
        window.addEventListener('message', (e) => {
            if (e.data.type === 'BOT_CONNECTED') {
                const status = document.getElementById('connection-status');
                status.innerText = "ğŸŸ¢ ××—×•×‘×¨ ×•××•×›×Ÿ ×œ×¢×‘×•×“×”!";
                status.style.background = "#28a745";
                govMapWindow = e.source;
            }

            if (e.data.type === 'DATA_EXTRACTED') {
                if (currentProcessIndex === -1) return;
                const data = e.data.payload;
                const row = document.getElementById(`row-${currentProcessIndex}`);
                
                row.querySelector('.status').innerHTML = '<span class="status-done">âœ… × ×©××¨</span>';
                row.querySelector('.extracted-data').innerText = data.substring(0, 50) + '...';
                row.style.backgroundColor = '#d4edda';
                addresses[currentProcessIndex].data = data;
                
                new Audio('https://freesound.org/data/previews/171/171671_2437358-lq.mp3').play().catch(()=>{});
            }
        });
        
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF×›×ª×•×‘×ª,××™×“×¢\n";
            addresses.forEach(addr => {
                csvContent += `${addr.original.replace(/,/g, ' ')},"${addr.data.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";")}"\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "govmap_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>

