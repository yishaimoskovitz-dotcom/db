<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovMap Pro - V5 Hunter</title>
    <style>
        :root { --primary: #0044cc; --success: #28a745; --bg: #f4f6f9; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 300px; background: white; padding: 20px; border-left: 1px solid #ddd; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .step { padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.95rem; border: 1px solid #eee; position: relative; }
        .step-num { position: absolute; top: -10px; right: -10px; background: var(--primary); color: white; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; }
        
        #bookmarklet-link {
            display: block; background: #d63384; color: white; text-decoration: none; padding: 12px;
            text-align: center; border-radius: 6px; font-weight: bold; border: 2px dashed #ff99cc; cursor: grab; margin-top: 10px;
        }
        
        table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; position: sticky; top: 0; }
        .status-done { color: var(--success); font-weight: bold; }
        .pop-stats { font-size: 0.85rem; color: #555; background: #fdfdfe; padding: 2px 5px; border-radius: 4px; border: 1px solid #eee; }
        
        #connection-status { 
            position: fixed; bottom: 20px; left: 20px; background: #dc3545; color: white; 
            padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .action-btn { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-open { background: var(--success); color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>ğŸ“˜ ×”×•×¨××•×ª ×ª×™×§×•×Ÿ (V5)</h3>
        
        <div class="step">
            <div class="step-num">1</div>
            <strong>×’×¨×™×¨×ª ×”×‘×•×˜ ×”×—×“×©</strong>
            ××—×§ ××ª ×”×§×•×“× ×•×’×¨×•×¨ ××ª ×–×”:
            <a id="bookmarklet-link" href="#" onclick="alert('×œ×’×¨×•×¨ ×œ××¢×œ×”!'); return false;">ğŸ¤– ×‘×•×˜ V5 (×”×¦×™×™×“)</a>
        </div>

        <div class="step">
            <div class="step-num">2</div>
            <strong>×¤×ª×™×—×”</strong>
            <button class="action-btn btn-open" onclick="openGovMapWindow()">ğŸŒ ×¤×ª×— ×—×œ×•×Ÿ GovMap</button>
            <p style="font-size:0.85rem; margin-top:5px; color:#d63384;">
                * ×•×•×“× ×©××™×Ÿ ×—×•×¡× ×¤×•×¤-××¤.
            </p>
        </div>

        <div class="step">
            <div class="step-num">3</div>
            <strong>×—×™×‘×•×¨</strong>
            ×‘×—×œ×•×Ÿ ×”××¤×” -> ×œ×—×¥ ×¢×œ ×”×‘×•×˜ ×‘××•×¢×“×¤×™×.
            <br>
            <b>×—×•×‘×” ×œ×¨××•×ª ×”×•×“×¢×” ×™×¨×•×§×” "××—×•×‘×¨".</b>
        </div>
    </div>

    <div style="flex: 1; padding: 30px; overflow-y: auto;">
        <h1>××¢×¨×›×ª ××©×•×œ×‘×ª V5</h1>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label style="font-weight:bold;">×”×–×Ÿ ×›×ª×•×‘×•×ª:</label>
            <textarea id="addressInput" style="width:100%; height:100px; margin:10px 0; padding:10px; border:1px solid #ccc;" placeholder="×”×¨×¦×œ, 15, ×ª×œ ××‘×™×‘&#10;×–'×‘×•×˜×™× ×¡×§×™, 2, ×‘× ×™ ×‘×¨×§"></textarea>
            <button onclick="loadAddresses()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">×˜×¢×Ÿ ×›×ª×•×‘×•×ª</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>×›×ª×•×‘×ª</th>
                    <th>×¢×™×¨</th>
                    <th>× ×¤×©×•×ª</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>××™×“×¢</th>
                    <th>×¤×¢×•×œ×”</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <br>
        <button id="exportBtn" onclick="exportToCSV()" style="background:#17a2b8; color:white; border:none; padding:10px 20px; display:none; border-radius:4px; cursor:pointer;">×”×•×¨×“ ××§×¡×œ</button>
    </div>

    <div id="connection-status">ğŸ”´ ×× ×•×ª×§</div>

    <script>
        // === ××™×œ×•×Ÿ × ×ª×•× ×™× ===
        const CITY_STATS = {
            "×™×¨×•×©×œ×™×": 3.8, "×ª×œ ××‘×™×‘ - ×™×¤×•": 2.2, "×—×™×¤×”": 2.4, "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ": 2.9,
            "×¤×ª×— ×ª×§×•×•×”": 3.0, "××©×“×•×“": 3.2, "× ×ª× ×™×”": 3.0, "×‘××¨ ×©×‘×¢": 2.9,
            "×‘× ×™ ×‘×¨×§": 4.8, "×—×•×œ×•×Ÿ": 2.8, "×¨××ª ×’×Ÿ": 2.3, "×¨×—×•×‘×•×ª": 2.9
        };

        function getCityStats(address) {
            let city = address.split(",").pop().trim();
            for (let key in CITY_STATS) {
                if (city.includes(key)) return { city: key, avg: CITY_STATS[key] };
            }
            return { city: city, avg: 0 };
        }

        // === ×‘×•×˜ V5: ×”"×¦×™×™×“" ===
        const botCode = `
            (function(){
                // 1. ×‘×“×™×§×ª ×¡×‘×™×‘×”
                if(location.hostname.indexOf('govmap')===-1){alert('âŒ ×”×‘×•×˜ ×¢×•×‘×“ ×¨×§ ×‘-GovMap!');return;}
                if(!window.opener){alert('âŒ × ×•×ª×§ ×”×§×©×¨! ×¢×œ×™×š ×œ×¡×’×•×¨ ××ª ×”×˜××‘ ×•×œ×¤×ª×•×— ××—×“×© ×“×¨×š ×”××ª×¨.');return;}
                
                window.opener.postMessage({type:'BOT_CONNECTED'},'*');
                alert('âœ… ×”×‘×•×˜ ×—×•×‘×¨!\\n\\n×¢×›×©×™×• ×”×“×œ×§ ×©×›×‘×•×ª ×•××– ×©×œ×— ×›×ª×•×‘×•×ª.');
                
                // ×¤×•× ×§×¦×™×” ××’×¨×¡×™×‘×™×ª ×œ××¦×™××ª ×”×—×™×¤×•×©
                function simulateSearch(text) {
                    console.log("ğŸ¤– ×”×‘×•×˜ ××—×¤×© ××ª: " + text);

                    // ×¨×©×™××ª ×›×œ ×”××§×•××•×ª ×”××¤×©×¨×™×™× ×©×‘×”× GovMap ××—×‘×™××™× ××ª ×”×—×™×¤×•×©
                    let potentialInputs = [
                        document.getElementById('txtSearch'),
                        document.querySelector('input[placeholder*="×›×ª×•×‘×ª"]'),
                        document.querySelector('input[placeholder*="×’×•×©"]'),
                        document.querySelector('.search-input'),
                        document.querySelector('#mainSearchInput'),
                        document.querySelector('input[type="search"]')
                    ];

                    // ×¡×™× ×•×Ÿ ×•×œ×§×—×ª ××ª ×”×¨××©×•×Ÿ ×©×§×™×™×
                    let input = potentialInputs.find(i => i !== null);

                    if(!input) {
                        // ×›××•×¦× ××—×¨×•×Ÿ: ×—×¤×© ×›×œ ××™× ×¤×•×˜ ×˜×§×¡×˜ ×‘×—×œ×§ ×”×¢×œ×™×•×Ÿ ×©×œ ×”×“×£
                        let allInputs = document.querySelectorAll('input[type="text"]');
                        if(allInputs.length > 0) input = allInputs[0];
                    }

                    if(input) {
                        console.log("âœ… ×©×•×¨×ª ×”×—×™×¤×•×© × ××¦××”:", input);
                        
                        // 1. × ×™×§×•×™ ×•×¤×•×§×•×¡
                        input.value = '';
                        input.focus();
                        input.click();

                        // 2. ×”×–× ×” "×× ×•×©×™×ª"
                        input.value = text;
                        input.dispatchEvent(new Event('input', {bubbles:true}));
                        input.dispatchEvent(new Event('change', {bubbles:true}));
                        
                        // 3. × ×™×¡×™×•×Ÿ ×œ×—×™×¦×” ×¢×œ ×× ×˜×¨
                        setTimeout(() => {
                            input.dispatchEvent(new KeyboardEvent('keydown', {'key': 'Enter', 'code': 'Enter', 'which': 13, 'bubbles': true}));
                            input.dispatchEvent(new KeyboardEvent('keypress', {'key': 'Enter', 'code': 'Enter', 'which': 13, 'bubbles': true}));
                            input.dispatchEvent(new KeyboardEvent('keyup', {'key': 'Enter', 'code': 'Enter', 'which': 13, 'bubbles': true}));
                            
                            // 4. × ×™×¡×™×•×Ÿ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×–×›×•×›×™×ª ××’×“×œ×ª
                            let btn = document.querySelector('#btnSearch') || document.querySelector('.search-btn');
                            if(btn) { 
                                btn.click();
                                console.log("âœ… × ×œ×—×¥ ×›×¤×ª×•×¨ ×—×™×¤×•×©");
                            }
                        }, 300);

                    } else {
                        alert('âŒ ×”×‘×•×˜ ×œ× ××•×¦× ××ª ×©×•×¨×ª ×”×—×™×¤×•×©! × ×¡×” ×œ×¨×¢× ×Ÿ ××ª GovMap.');
                    }
                }

                // ×”××–× ×” ×œ×¤×§×•×“×•×ª
                window.addEventListener('message', function(e){
                    if(e.data.type === 'SEARCH_ADDRESS') {
                        simulateSearch(e.data.text);
                    }
                });

                // ×¡×•×¨×§ ×”×‘×•×¢×•×ª (Scraper)
                const obs = new MutationObserver(() => {
                    let p = document.querySelector('.esri-popup__content');
                    if(p && p.innerText.length > 5 && !p.dataset.scraped) {
                        p.dataset.scraped = "true";
                        window.opener.postMessage({type:'DATA_EXTRACTED', payload: p.innerText.replace(/\\s+/g,' ').trim()}, '*');
                        
                        let b = document.createElement('div');
                        b.innerText = 'âœ… × ×©×œ×—!';
                        b.style.cssText = 'position:fixed;top:100px;right:20px;background:#28a745;color:white;padding:10px;z-index:9999;border-radius:5px;';
                        document.body.appendChild(b);
                        setTimeout(() => b.remove(), 2000);
                    }
                });
                obs.observe(document.body, {childList:true, subtree:true});

            })();
        `;
        document.getElementById('bookmarklet-link').href = 'javascript:' + encodeURIComponent(botCode);

        // === ×œ×•×’×™×§×” ×©×œ ×”××ª×¨ ===
        let govMapWindow = null;
        let addresses = [];
        let currentProcessIndex = -1;

        function openGovMapWindow() {
            govMapWindow = window.open('https://www.govmap.gov.il/?app=dashboard', 'govmap_window');
        }

        function loadAddresses() {
            const rawText = document.getElementById('addressInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            addresses = [];

            lines.forEach((line, index) => {
                const stats = getCityStats(line);
                const rangeLow = stats.avg > 0 ? (stats.avg - 0.5).toFixed(1) : 0;
                const rangeHigh = stats.avg > 0 ? (stats.avg + 0.5).toFixed(1) : 0;

                const addrObj = { 
                    id: index, 
                    original: line.trim(), 
                    data: '', 
                    city: stats.city,
                    rangeLow: parseFloat(rangeLow),
                    rangeHigh: parseFloat(rangeHigh)
                };
                addresses.push(addrObj);
                
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${line}</td>
                    <td>${stats.city}</td>
                    <td>${stats.avg > 0 ? rangeLow + '-' + rangeHigh : '-'}</td>
                    <td class="status">×××ª×™×Ÿ</td>
                    <td class="extracted-data">-</td>
                    <td><button class="action-btn" style="background:#007bff; color:white;" onclick="sendToMap(${index})">×—×¤×©</button></td>
                `;
                tbody.appendChild(tr);
            });
            if(addresses.length > 0) document.getElementById('exportBtn').style.display = 'inline-block';
        }

        function sendToMap(index) {
            if (!govMapWindow || govMapWindow.closed) {
                alert("×—×œ×•×Ÿ GovMap ×¡×’×•×¨! ×¤×ª×— ××—×“×©."); return;
            }
            currentProcessIndex = index;
            const address = addresses[index].original.replace(/,/g, ' ');
            
            document.querySelectorAll('tr').forEach(r => r.style.background = 'white');
            const row = document.getElementById(`row-${index}`);
            row.style.backgroundColor = '#fff3cd';
            row.querySelector('.status').innerText = 'â³ × ×©×œ×—...';

            govMapWindow.postMessage({type: 'SEARCH_ADDRESS', text: address}, '*');
        }

        window.addEventListener('message', (e) => {
            if (e.data.type === 'BOT_CONNECTED') {
                const status = document.getElementById('connection-status');
                status.innerText = "ğŸŸ¢ ××—×•×‘×¨!";
                status.style.background = "#28a745";
                govMapWindow = e.source;
            }
            if (e.data.type === 'DATA_EXTRACTED') {
                if (currentProcessIndex === -1) return;
                const data = e.data.payload;
                const row = document.getElementById(`row-${currentProcessIndex}`);
                
                row.querySelector('.status').innerHTML = '<span class="status-done">âœ… × ×©××¨</span>';
                row.querySelector('.extracted-data').innerText = data.substring(0, 40) + '...';
                row.style.backgroundColor = '#d4edda';
                addresses[currentProcessIndex].data = data;
            }
        });

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Address,City,Range Low,Range High,GovMap Data\n";
            let totalLow = 0, totalHigh = 0;
            addresses.forEach(addr => {
                totalLow += addr.rangeLow;
                totalHigh += addr.rangeHigh;
                csvContent += `${addr.original.replace(/,/g, " ")},${addr.city},${addr.rangeLow},${addr.rangeHigh},"${addr.data.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";")}"\n`;
            });
            csvContent += `TOTAL,,,${totalLow.toFixed(1)},${totalHigh.toFixed(1)},SUM_ROW\n`;
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "govmap_full_analysis.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
