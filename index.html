<!DOCTYPE html>
<html dir="rtl">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyst Data Hub</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      body { font-family: 'Rubik', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
      .bg-gradient-animate {
        background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
        opacity: 0.05;
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
      }
      @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
      .fade-in-up { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
      @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
      .spin { animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      .input-group { @apply relative mb-4; }
      .input-field { @apply w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all placeholder:text-slate-400; }
      .input-label { @apply block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide; }
      datalist { display: none; }
      
      .hashtag-chip { @apply px-3 py-1 rounded-full text-xs font-bold cursor-pointer transition-all border; }
      .hashtag-chip.active { @apply bg-indigo-600 text-white border-indigo-600; }
      .hashtag-chip.inactive { @apply bg-white text-slate-500 border-slate-200 hover:border-indigo-300 hover:text-indigo-600; }
    </style>
  </head>
  <body class="text-slate-800">
    <div class="bg-gradient-animate"></div>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;

      // --- הגדרות ---
      const SHEET_ID = '1myMr9MeMtgAcipoR1rJaX3MdamlIBZugt_TX5eafX7Q';
      const GOOGLE_CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2Y9fk6DHEU5QB9FTxS77y7bvIDHPncOFVVLCH1G-lryHKM27nSVjEUscBEHmtnU2F/exec"; 
      
      const MANAGER_EMAIL = "yishaimoskovitz@gmail.com";
      let GLOBAL_USER_EMAIL = "";

      // הגדרה מרכזית של השדות
      const FORM_FIELDS = [
        { key: 'domain', label: 'נושא ראשי (Domain)', type: 'text' },
        { key: 'subTopic', label: 'תת-נושא / שם הדוח', type: 'text' },
        { key: 'owner', label: 'אחראי (Owner)', type: 'text' },
        { key: 'sourceName', label: 'מקור נתונים (Source)', type: 'text' },
        { key: 'link', label: 'קישור (Link)', type: 'text', noPlaceholder: true },
        { key: 'extraInfo', label: 'מידע נוסף', type: 'textarea' }
      ];

      // --- פונקציות עזר ---
      const parseCSV = (str) => {
        const arr = [];
        let quote = false;
        let col = 0, row = 0;
        let c = 0;
        for (; c < str.length; c++) {
          let cc = str[c], nc = str[c+1];
          arr[row] = arr[row] || [];
          arr[row][col] = arr[row][col] || '';
          if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
          if (cc == '"') { quote = !quote; continue; }
          if (cc == ',' && !quote) { ++col; continue; }
          if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
          if (cc == '\n' && !quote) { ++row; col = 0; continue; }
          if (cc == '\r' && !quote) { ++row; col = 0; continue; }
          arr[row][col] += cc;
        }
        return arr;
      };

      const Icon = ({ name, size = 16, className = "" }) => {
        const ref = useRef(null);
        useEffect(() => {
          if (window.lucide && ref.current) {
            ref.current.innerHTML = '';
            const i = document.createElement('i');
            i.setAttribute('data-lucide', name);
            i.style.width = `${size}px`;
            i.style.height = `${size}px`;
            i.className = className;
            ref.current.appendChild(i);
            try { window.lucide.createIcons({ root: ref.current, icons: { [name]: window.lucide.icons[name] } }); } catch(e) {}
          }
        }, [name, size, className]);
        return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{width: size, height: size}}></span>;
      };

      // --- רכיב Linkify המעודכן (מזהה כל סוג של קישור) ---
      const Linkify = ({ content }) => {
        if (typeof content !== 'string') return content;
        
        // ביטוי רגולרי שתופס גם http/s וגם www
        const parts = content.split(/((?:https?:\/\/|www\.)[^\s]+|(?:#[\w\u0590-\u05FF]+))/g);
        
        return (
           <>
             {parts.map((p, i) => {
                // זיהוי קישור (http או www)
                if (p.match(/^(https?:\/\/|www\.)/)) {
                   // אם זה מתחיל ב-www, נוסיף https כדי שהדפדפן יבין
                   const href = p.startsWith('www.') ? `https://${p}` : p;
                   return (
                      <a key={i} 
                         href={href} 
                         target="_blank" 
                         rel="noopener noreferrer" 
                         className="text-indigo-600 hover:underline z-10 relative break-all font-medium" 
                         onClick={e=>e.stopPropagation()}>
                         {p}
                      </a>
                   );
                }
                // זיהוי האשטאג
                if (p.match(/^#/)) {
                   return <span key={i} className="text-pink-600 font-bold">{p}</span>;
                }
                return p;
             })}
           </>
        );
      };

      const getDomainColor = (domain) => {
        if (!domain) return "bg-gray-100 text-gray-700 border-gray-200";
        if (domain === "בקשת מידע") return "bg-orange-50 text-orange-700 border-orange-200 dashed-border";
        const d = domain.toString().toLowerCase();
        if (d.includes("שיווק")) return "bg-blue-50 text-blue-700 border-blue-200";
        if (d.includes("כספים")) return "bg-emerald-50 text-emerald-700 border-emerald-200";
        if (d.includes("מוצר")) return "bg-purple-50 text-purple-700 border-purple-200";
        if (d.includes("משאבי אנוש")) return "bg-rose-50 text-rose-700 border-rose-200";
        if (d.includes("טכנולוגיה")) return "bg-cyan-50 text-cyan-700 border-cyan-200";
        return "bg-indigo-50 text-indigo-700 border-indigo-200";
      };

      // --- כרטיס ---
      const Card = ({ item, onClick, index }) => {
        const isRequest = item.domain === "בקשת מידע";
        const isUrgent = isRequest && item.extraInfo && item.extraInfo.includes("דחיפות: גבוהה");
        const followers = item.interestedUsers ? item.interestedUsers.split(",").filter(Boolean).length : 0;
        const comments = item.comments ? JSON.parse(item.comments).length : 0;
        const colorClass = getDomainColor(item.domain);
        
        return (
          <div onClick={onClick} style={{ animationDelay: `${index * 50}ms` }} 
               className={`group fade-in-up bg-white/80 backdrop-blur-sm rounded-2xl border shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer flex flex-col h-full overflow-hidden relative 
               ${isRequest ? 'border-orange-200 border-dashed bg-orange-50/30' : 'border-slate-200/60'}
               ${isUrgent ? 'ring-2 ring-red-400 ring-offset-2' : ''}
               `}>
            
            <div className={`h-1.5 w-full bg-gradient-to-r from-transparent via-current to-transparent opacity-50 ${colorClass.split(" ")[1]}`}></div>
            
            <div className="p-5 flex flex-col h-full">
              <div className="flex justify-between items-start mb-4">
                <span className={`text-[11px] font-bold px-3 py-1 rounded-full border tracking-wide uppercase ${colorClass}`}>
                  {isRequest ? "תהליך פנייה" : item.subTopic}
                </span>
                <div className="flex gap-2 text-slate-400 text-[10px] items-center">
                  {isUrgent && <div className="flex items-center text-red-600 animate-pulse"><Icon name="Flame" size={12} /></div>}
                  {followers > 0 && <span className="flex items-center gap-0.5"><Icon name="Bell" size={10} /> {followers}</span>}
                  {comments > 0 && <span className="flex items-center gap-0.5"><Icon name="MessageSquare" size={10} /> {comments}</span>}
                </div>
              </div>
              
              <h3 className="text-xl font-bold text-slate-800 leading-tight mb-3 group-hover:text-indigo-600 transition-colors">
                 {isRequest ? item.subTopic : item.domain}
              </h3>

              <div className="mt-auto pt-4 border-t border-slate-100 flex items-center justify-between text-slate-500 text-sm">
                 <div className="flex items-center gap-1.5">
                    <div className={`${isRequest ? 'bg-orange-100' : 'bg-slate-100'} p-1 rounded-full`}>
                      <Icon name={isRequest ? "HelpCircle" : "User"} size={12} className={isRequest ? "text-orange-600" : ""} />
                    </div>
                    <span className="truncate max-w-[100px]">{item.owner}</span>
                 </div>
              </div>
            </div>
          </div>
        );
      };

      // --- מודל צפייה ועדכון מורחב ---
      const DetailedModal = ({ item, onClose, onRefresh, fullData }) => {
        const [mode, setMode] = useState('view');
        const [userEmail, setUserEmail] = useState(GLOBAL_USER_EMAIL);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [commentText, setCommentText] = useState("");
        const [editData, setEditData] = useState({...item});

        const isRequest = item.domain === "בקשת מידע";
        const followers = item.interestedUsers ? item.interestedUsers.split(",").filter(Boolean) : [];
        const isFollowing = userEmail && followers.includes(userEmail);
        const commentsList = item.comments ? JSON.parse(item.comments) : [];

        // חישוב דוגמאות (Placeholders)
        const getPlaceholder = (fieldKey) => {
           for (let i = 0; i < fullData.length; i++) {
              if (fullData[i][fieldKey] && fullData[i][fieldKey].trim() !== "") {
                 return "למשל: " + fullData[i][fieldKey];
              }
           }
           return "";
        };

        const handleSaveEdit = async () => {
          setIsSubmitting(true);
          try {
            await fetch(APPS_SCRIPT_URL, {
              method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'update', id: item.id, ...editData })
            });
            setTimeout(() => { onRefresh(); onClose(); }, 1500);
          } catch(e) { alert("שגיאה"); setIsSubmitting(false); }
        };

        const handleToggleFollow = async () => {
          if (!userEmail) { setMode('auth_for_action'); return; }
          setIsSubmitting(true);
          try {
            await fetch(APPS_SCRIPT_URL, {
              method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'toggleFollow', id: item.id, userEmail })
            });
            setTimeout(() => { onRefresh(); onClose(); }, 1000);
          } catch(e) { setIsSubmitting(false); }
        };

        const handleAddComment = async () => {
          if (!userEmail) { setMode('auth_for_action'); return; }
          if (!commentText.trim()) return;
          setIsSubmitting(true);
          try {
             await fetch(APPS_SCRIPT_URL, {
              method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'addComment', id: item.id, userEmail, text: commentText })
            });
            setTimeout(() => { onRefresh(); onClose(); }, 1000);
          } catch(e) { setIsSubmitting(false); }
        };

        if (mode === 'auth_for_action') {
           return (
             <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50" onClick={() => setMode('view')}>
                <div className="bg-white p-6 rounded-xl w-full max-w-sm" onClick={e=>e.stopPropagation()}>
                   <h3 className="text-lg font-bold mb-4">נדרשת הזדהות</h3>
                   <input type="email" name="email" autoComplete="email" placeholder="הכנס אימייל..." className="input-field mb-4" 
                     value={userEmail} onChange={e => setUserEmail(e.target.value)} />
                   <button onClick={() => { if(userEmail.includes('@')) { GLOBAL_USER_EMAIL = userEmail; setMode('view'); } }} className="w-full bg-indigo-600 text-white py-2 rounded-lg">התחבר</button>
                </div>
             </div>
           )
        }

        if (mode === 'edit') {
           return (
             <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}>
                <div className="bg-white rounded-2xl w-full max-w-lg p-6 overflow-y-auto max-h-[90vh]" onClick={e=>e.stopPropagation()}>
                   <h2 className="text-xl font-bold mb-4">{isRequest ? "הפיכה למקור מידע" : "עריכת פרטים"}</h2>
                   <div className="space-y-4">
                      {FORM_FIELDS.map(field => (
                         <div key={field.key}>
                            <label className="input-label">{field.label}</label>
                            {field.type === 'textarea' ? (
                               <textarea 
                                 className="input-field min-h-[80px]" 
                                 placeholder={getPlaceholder(field.key)}
                                 value={editData[field.key]} 
                                 onChange={e => setEditData({...editData, [field.key]: e.target.value})} 
                               />
                            ) : (
                               <input 
                                 type="text" 
                                 className="input-field" 
                                 placeholder={field.noPlaceholder ? "" : getPlaceholder(field.key)}
                                 value={editData[field.key]} 
                                 onChange={e => setEditData({...editData, [field.key]: e.target.value})} 
                               />
                            )}
                         </div>
                      ))}
                      <button onClick={handleSaveEdit} disabled={isSubmitting} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">{isSubmitting ? 'שומר...' : 'שמור עדכונים'}</button>
                      <button onClick={()=>setMode('view')} className="w-full text-slate-500 py-2">ביטול</button>
                   </div>
                </div>
             </div>
           )
        }

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={onClose}>
            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col" onClick={e => e.stopPropagation()}>
              <div className={`p-6 border-b border-slate-100 flex justify-between items-start ${isRequest ? 'bg-orange-50' : 'bg-slate-50/50'}`}>
                <div>
                  <div className="flex gap-2 items-center mb-2">
                     <span className={`text-xs font-bold px-2.5 py-1 rounded-full border ${getDomainColor(item.domain)}`}>{item.domain}</span>
                     {isRequest && <span className="text-xs font-bold text-orange-600 animate-pulse">בקשה פתוחה</span>}
                  </div>
                  <h2 className="text-2xl font-bold text-slate-900">{item.subTopic}</h2>
                </div>
                <div className="flex gap-2">
                   <button onClick={() => { if(!userEmail) setMode('auth_for_action'); else setMode('edit'); }} className="p-2 bg-white border border-slate-200 rounded-full hover:bg-slate-100 text-slate-500"><Icon name="Edit3" size={18} /></button>
                   <button onClick={handleToggleFollow} className={`p-2 border rounded-full transition-colors ${isFollowing ? 'bg-indigo-100 border-indigo-200 text-indigo-600' : 'bg-white border-slate-200 text-slate-400 hover:text-indigo-500'}`}><Icon name={isFollowing ? "BellRing" : "Bell"} size={18} /></button>
                   <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full text-slate-400"><Icon name="X" size={24} /></button>
                </div>
              </div>
              <div className="p-6 space-y-6">
                
                {/* הצגת כל השדות בצורה דינמית */}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                   {FORM_FIELDS.map(field => (
                      <div key={field.key} className={`bg-slate-50 p-4 rounded-2xl border border-slate-100 ${field.key === 'extraInfo' ? 'col-span-full' : ''}`}>
                         <div className="text-xs text-slate-400 mb-1 font-bold uppercase">{field.label}</div>
                         <div className="whitespace-pre-wrap word-break text-slate-800">
                            {/* רכיב Linkify המעודכן מטפל בכל הקישורים כאן */}
                            <Linkify content={item[field.key] || "-"} />
                         </div>
                      </div>
                   ))}
                </div>

                {/* כפתור הפיכה למקור (רק אם זו בקשה) */}
                {isRequest && (
                   <div className="bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex justify-between items-center">
                      <span className="text-indigo-800 text-sm font-medium">השגת את הנתונים? הפוך את הבקשה למקור מידע רשמי.</span>
                      <button onClick={() => { if(!userEmail) { setMode('auth_for_action'); return; } setEditData({...item, domain: '', extraInfo: item.extraInfo + '\n[הבקשה הושלמה]', status: 'Closed'}); setMode('edit'); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700">עדכן למקור</button>
                   </div>
                )}

                {/* תגובות */}
                <div className="border-t border-slate-100 pt-6">
                   <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="MessageCircle" size={18}/> דיון והערות ({commentsList.length})</h3>
                   <div className="max-h-40 overflow-y-auto mb-4 space-y-3">
                      {commentsList.length === 0 && <p className="text-slate-400 text-sm italic">אין עדיין תגובות.</p>}
                      {commentsList.map((c, i) => (
                         <div key={i} className="flex gap-3"><div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500 text-xs font-bold shrink-0">{c.user.substring(0,2).toUpperCase()}</div><div><div className="bg-slate-100 px-3 py-2 rounded-xl rounded-tr-none text-sm text-slate-700">{c.text}</div><div className="text-[10px] text-slate-400 mt-1 mr-1">{c.user.split('@')[0]} • {new Date(c.date).toLocaleDateString()}</div></div></div>
                      ))}
                   </div>
                   <div className="flex gap-2"><input className="flex-grow bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm outline-none focus:border-indigo-500" placeholder="כתוב תגובה..." value={commentText} onChange={e => setCommentText(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddComment()} /><button onClick={handleAddComment} disabled={isSubmitting} className="bg-indigo-600 text-white p-2 rounded-xl hover:bg-indigo-700 disabled:opacity-50"><Icon name="Send" size={18} /></button></div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // --- Wizards ---
      const RequestSourceWizard = ({ onClose, onRefresh }) => {
        const [step, setStep] = useState(1);
        const [isSubmitting, setIsSubmitting] = useState(false);
        const [requestData, setRequestData] = useState({ requesterName: '', requesterEmail: '', targetOffice: '', dataDesc: '', urgency: 'רגילה' });

        const handleSubmitRequest = async (e) => {
          e.preventDefault(); setIsSubmitting(true);
          const payload = { 
            action:'create', 
            domain: "בקשת מידע", 
            subTopic: requestData.dataDesc, 
            owner: requestData.requesterName, 
            sourceName: requestData.targetOffice, 
            extraInfo: `דחיפות: ${requestData.urgency} | מייל המבקש: ${requestData.requesterEmail} | תאריך: ${new Date().toLocaleDateString()}` 
          };
          try { 
            await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
            setTimeout(() => { onRefresh(); onClose(); }, 500); 
          } catch (error) { alert("שגיאה"); } finally { setIsSubmitting(false); }
        };

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={onClose}>
            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
              
              <div className="bg-indigo-600 p-6 text-white text-center relative overflow-hidden">
                 <div className="absolute top-0 left-0 w-full h-full bg-white opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                 <h2 className="text-2xl font-bold relative z-10">
                   {step === 1 ? 'בדיקת קטלוג' : step === 2 ? 'בדיקת רשת' : 'פתיחת בקשה'}
                 </h2>
                 <p className="text-indigo-200 text-sm relative z-10">צעד {step} מתוך 3</p>
                 <button onClick={onClose} className="absolute top-4 left-4 p-1 hover:bg-white/20 rounded-full transition"><Icon name="X" size={20} /></button>
              </div>

              <div className="p-8 overflow-y-auto">
                {step === 1 && (
                  <div className="text-center space-y-6">
                    <div className="bg-indigo-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                      <Icon name="Library" size={48} className="text-indigo-600" />
                    </div>
                    <h3 className="text-xl font-bold text-slate-800">האם בדקת אם הנתונים שאתה מחפש נמצאים בקטלוג?</h3>
                    <div className="flex gap-3 pt-4">
                       <button onClick={onClose} className="flex-1 py-3 border border-slate-200 rounded-xl text-slate-600 font-bold hover:bg-slate-50 hover:border-slate-300 transition-all">בודק שוב...</button>
                      <button onClick={() => setStep(2)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">בדקתי, לא נמצא</button>
                    </div>
                  </div>
                )}

                {step === 2 && (
                  <div className="text-center space-y-6">
                    <div className="bg-cyan-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                      <Icon name="Globe" size={48} className="text-cyan-600" />
                    </div>
                    <h3 className="text-xl font-bold text-slate-800">האם המידע פומבי? ניסית לחפש את הנתונים באינטרנט?</h3>
                    <div className="flex gap-3 pt-4">
                       <button onClick={() => setStep(1)} className="px-4 py-3 text-slate-400 font-bold hover:text-slate-600">חזור</button>
                      <button onClick={() => setStep(3)} className="flex-1 py-3 bg-cyan-600 text-white rounded-xl font-bold hover:bg-cyan-700 shadow-lg shadow-cyan-200 transition-all">חיפשתי, אין כלום</button>
                    </div>
                  </div>
                )}

                {step === 3 && (
                  <div className="space-y-6">
                    <div className="text-center">
                       <p className="text-slate-600 font-medium mb-4 leading-relaxed">
                         מעולה, שלח מייל לאיש הקשר מהמשרד בבקשה לנתונים שאתה מחפש ובמקביל פתח ממש כאן למטה פנייה חדשה ועדכן אותה בהתאם :)
                       </p>
                       
                       <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 text-center">
                          <div className="text-sm font-bold text-slate-500 mb-1">צריך להתייעץ לפני?</div>
                          <div className="text-indigo-600 font-bold text-lg select-all cursor-pointer hover:text-indigo-800" title="לחץ להעתקה" onClick={(e) => {
                             navigator.clipboard.writeText(MANAGER_EMAIL);
                             alert("המייל הועתק!");
                          }}>
                             {MANAGER_EMAIL}
                          </div>
                       </div>
                    </div>

                    <form onSubmit={handleSubmitRequest} className="space-y-4 bg-white rounded-xl">
                       <h3 className="font-bold text-lg border-b pb-2 mb-4 text-slate-800">פרטי הבקשה</h3>
                       
                       <div className="input-group">
                          <label className="input-label">אילו נתונים אתה מחפש?</label>
                          <input required className="input-field" placeholder="למשל: נתוני תאונות דרכים 2024" 
                            value={requestData.dataDesc} onChange={e => setRequestData({...requestData, dataDesc: e.target.value})} />
                       </div>
                       
                       <div className="input-group">
                          <label className="input-label">לאיזה משרד אתה פונה?</label>
                          <input required className="input-field" placeholder="למשל: הלמ״ס" 
                             value={requestData.targetOffice} onChange={e => setRequestData({...requestData, targetOffice: e.target.value})} />
                       </div>

                       <div className="grid grid-cols-2 gap-4">
                          <div className="input-group">
                             <label className="input-label">מה השם שלך?</label>
                             <input required className="input-field" placeholder="שם מלא" 
                               value={requestData.requesterName} onChange={e => setRequestData({...requestData, requesterName: e.target.value})} />
                          </div>
                          <div className="input-group">
                             <label className="input-label">מה המייל שלך?</label>
                             <input type="email" name="email" autoComplete="email" required className="input-field" placeholder="your@email.com" 
                               value={requestData.requesterEmail} onChange={e => setRequestData({...requestData, requesterEmail: e.target.value})} />
                          </div>
                       </div>

                       <button type="submit" disabled={isSubmitting} className={`w-full bg-slate-900 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:bg-slate-800 mt-2 flex justify-center gap-2 ${isSubmitting ? 'opacity-70' : ''}`}>
                         {isSubmitting ? 'שולח...' : <>פתח בקשה <Icon name="ArrowLeft" size={20}/></>}
                       </button>
                    </form>
                  </div>
                )}

              </div>
            </div></div>
        );
      };

      const AddDataModal = ({ onClose, onRefresh, fullData }) => {
         const [email, setEmail] = useState('');
         const [formData, setFormData] = useState({});
         
         const getPlaceholder = (fieldKey) => {
           for (let i = 0; i < fullData.length; i++) {
              if (fullData[i][fieldKey] && fullData[i][fieldKey].trim() !== "") return "למשל: " + fullData[i][fieldKey];
           }
           return "";
         };

         const handleSubmit = async (e) => {
            e.preventDefault();
            await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'create', ...formData, owner: formData.owner || email }) });
            setTimeout(() => { onRefresh(); onClose(); }, 1500);
         }
         return (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" onClick={onClose}>
               <div className="bg-white rounded-3xl p-6 w-full max-w-lg overflow-y-auto max-h-[90vh]" onClick={e=>e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-6">
                     <h2 className="font-bold text-xl">הוספת נתונים</h2>
                     <button onClick={onClose}><Icon name="X" size={24} className="text-slate-400"/></button>
                  </div>
                  
                  <form onSubmit={handleSubmit} className="space-y-4">
                     <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                        <label className="input-label">מייל מזהה (מי מעדכן?)</label>
                        <input type="email" name="email" autoComplete="email" className="input-field bg-white" value={email} onChange={e=>setEmail(e.target.value)} required placeholder="your@email.com" />
                     </div>

                     {FORM_FIELDS.map(field => (
                         <div key={field.key}>
                            <label className="input-label">{field.label}</label>
                            {field.type === 'textarea' ? (
                               <textarea 
                                 className="input-field min-h-[80px]" 
                                 placeholder={getPlaceholder(field.key)}
                                 value={formData[field.key] || ''} 
                                 onChange={e => setFormData({...formData, [field.key]: e.target.value})} 
                               />
                            ) : (
                               <input 
                                 type="text" 
                                 className="input-field" 
                                 placeholder={field.noPlaceholder ? "" : getPlaceholder(field.key)}
                                 value={formData[field.key] || ''} 
                                 onChange={e => setFormData({...formData, [field.key]: e.target.value})} 
                                 required={field.key === 'domain' || field.key === 'subTopic'}
                               />
                            )}
                         </div>
                      ))}

                     <button className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg mt-4">שמור נתונים</button>
                  </form>
               </div>
            </div>
         )
      };

      // --- Main App ---
      function App() {
        const [data, setData] = useState([]);
        const [searchTerm, setSearchTerm] = useState("");
        const [selectedDomain, setSelectedDomain] = useState(null);
        const [selectedTag, setSelectedTag] = useState(null);
        const [isLoading, setIsLoading] = useState(false);
        const [selectedItem, setSelectedItem] = useState(null);
        const [showAddModal, setShowAddModal] = useState(false);
        const [showRequestModal, setShowRequestModal] = useState(false);

        const fetchData = async () => {
          setIsLoading(true); 
          try {
            const response = await fetch(`https://corsproxy.io/?${encodeURIComponent(GOOGLE_CSV_URL + `&t=${Date.now()}`)}`);
            const text = await response.text();
            const rows = parseCSV(text);
            if (rows.length < 2) { setData([]); return; }
            
            const newData = rows.slice(1).map((row, index) => {
               if (row.length < 2) return null;
               return { 
                 id: index, 
                 domain: row[0] || "", 
                 subTopic: row[1] || "", 
                 owner: row[2] || "", 
                 sourceName: row[4] || "", 
                 link: row[5] || "",
                 extraInfo: row[6] || "",
                 interestedUsers: row[15] || "", 
                 comments: row[16] || "[]",      
                 status: row[17] || "Open"       
               };
            }).filter(i => i);
            setData(newData);
          } catch (err) { console.error(err); } finally { setIsLoading(false); }
        };

        useEffect(() => { fetchData(); }, []);

        const popularTags = useMemo(() => {
           const tags = {};
           data.forEach(item => {
              const found = item.extraInfo.match(/#[\w\u0590-\u05FF]+/g);
              if (found) found.forEach(t => tags[t] = (tags[t] || 0) + 1);
           });
           return Object.entries(tags).sort((a,b) => b[1] - a[1]).slice(0, 8).map(x => x[0]);
        }, [data]);

        const filteredData = useMemo(() => data.filter(item => {
            const term = searchTerm.toLowerCase();
            const matchesTag = selectedTag ? item.extraInfo.includes(selectedTag) : true;
            return matchesTag && Object.values(item).some(val => String(val).toLowerCase().includes(term)) && (selectedDomain ? item.domain === selectedDomain : true);
        }), [data, searchTerm, selectedDomain, selectedTag]);

        const domains = [...new Set(data.map(i => i.domain).filter(d => d && d !== "בקשת מידע"))].filter(Boolean);

        return (
          <div className="min-h-screen pb-20">
             <header className="bg-white/70 backdrop-blur-xl sticky top-0 z-30 border-b border-white/20 shadow-sm p-4 flex flex-col md:flex-row justify-between items-center gap-4">
                <div className="font-bold text-xl flex items-center gap-2 cursor-pointer" onClick={()=>{setSelectedDomain(null); setSelectedTag(null)}}><div className="bg-indigo-600 text-white p-2 rounded">Hub</div> Analyst Data Hub</div>
                <div className="flex gap-2 w-full md:w-auto overflow-x-auto">
                   <button onClick={() => setShowRequestModal(true)} className="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap border border-indigo-100 hover:bg-indigo-100">בקשה חדשה</button>
                   <button onClick={() => setShowAddModal(true)} className="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap shadow-md hover:bg-slate-800">הוסף נתונים</button>
                   <button onClick={fetchData} className="bg-white border px-3 py-2 rounded-xl"><Icon name="RefreshCw" size={18} className={isLoading?"spin":""}/></button>
                </div>
             </header>

             <div className="max-w-7xl mx-auto px-4 mt-8">
                <div className="mb-4"><input placeholder="חיפוש חופשי..." className="w-full bg-white p-3 rounded-xl border shadow-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                
                {popularTags.length > 0 && (
                   <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                      <span className="text-xs font-bold text-slate-400 self-center">נושאים חמים:</span>
                      {popularTags.map(tag => (
                         <div key={tag} onClick={() => setSelectedTag(selectedTag === tag ? null : tag)} 
                              className={`hashtag-chip ${selectedTag === tag ? 'active' : 'inactive'}`}>
                            {tag}
                         </div>
                      ))}
                   </div>
                )}

                <div className="flex flex-wrap gap-2 mb-8">
                   <button onClick={() => setSelectedDomain(null)} className={`px-4 py-2 rounded-xl font-bold text-sm ${!selectedDomain?'bg-slate-800 text-white':'bg-white'}`}>הכל</button>
                   <button onClick={() => setSelectedDomain("בקשת מידע")} className={`px-4 py-2 rounded-xl font-bold text-sm ${selectedDomain==="בקשת מידע"?'bg-orange-500 text-white':'bg-white text-orange-600 border border-orange-200'}`}>בקשות פתוחות</button>
                   {domains.map(d=><button key={d} onClick={() => setSelectedDomain(d)} className={`px-4 py-2 rounded-xl font-bold text-sm ${selectedDomain===d?'bg-slate-800 text-white':'bg-white'}`}>{d}</button>)}
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                   {filteredData.map((item, idx) => (
                      <Card key={idx} item={item} index={idx} onClick={() => setSelectedItem(item)} />
                   ))}
                </div>
             </div>

             {selectedItem && <DetailedModal item={selectedItem} onClose={() => setSelectedItem(null)} onRefresh={fetchData} fullData={data} />}
             {showAddModal && <AddDataModal onClose={() => setShowAddModal(false)} onRefresh={fetchData} fullData={data} />}
             {showRequestModal && <RequestSourceWizard onClose={() => setShowRequestModal(false)} onRefresh={fetchData} />}
          </div>
        );
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  </body>
</html>
