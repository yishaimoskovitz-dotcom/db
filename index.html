<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovMap Pro - Integrated Logic</title>
    <style>
        :root { --primary: #0044cc; --success: #28a745; --bg: #f4f6f9; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 300px; background: white; padding: 20px; border-left: 1px solid #ddd; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .step { padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.95rem; border: 1px solid #eee; position: relative; }
        .step-num { position: absolute; top: -10px; right: -10px; background: var(--primary); color: white; width: 25px; height: 25px; border-radius: 50%; text-align: center; line-height: 25px; font-weight: bold; }
        
        #bookmarklet-link {
            display: block; background: #6610f2; color: white; text-decoration: none; padding: 12px;
            text-align: center; border-radius: 6px; font-weight: bold; border: 2px dashed #bba1ea; cursor: grab; margin-top: 10px;
        }
        
        table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 0.9rem; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; position: sticky; top: 0; }
        .status-done { color: var(--success); font-weight: bold; }
        .pop-stats { font-size: 0.85rem; color: #555; background: #fdfdfe; padding: 2px 5px; border-radius: 4px; border: 1px solid #eee; }
        
        #connection-status { 
            position: fixed; bottom: 20px; left: 20px; background: #dc3545; color: white; 
            padding: 10px 20px; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .action-btn { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-open { background: var(--success); color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>ğŸ“˜ ×”×•×¨××•×ª (V4 ××©×•×œ×‘)</h3>
        
        <div class="step">
            <div class="step-num">1</div>
            <strong>×’×¨×™×¨×ª ×”×‘×•×˜</strong>
            ×× ×›×‘×¨ ×™×© ×œ×š ××ª "×‘×•×˜ V3", ×“×œ×’. ×× ×œ×, ×’×¨×•×¨:
            <a id="bookmarklet-link" href="#" onclick="alert('×œ×’×¨×•×¨ ×œ××¢×œ×”!'); return false;">ğŸ¤– ×‘×•×˜ V3</a>
        </div>

        <div class="step">
            <div class="step-num">2</div>
            <strong>×¤×ª×™×—×” ×•×”×’×“×¨×•×ª</strong>
            <button class="action-btn btn-open" onclick="openGovMapWindow()">ğŸŒ ×¤×ª×— ×—×œ×•×Ÿ GovMap</button>
            <p style="font-size:0.85rem; margin-top:5px; color:#d63384;">
                * ×—×•×‘×” ×œ×”×“×œ×™×§ ×©×›×‘×•×ª (× ×“×œ"×Ÿ/×’×•×©×™×) ×™×“× ×™×ª ×‘×—×œ×•×Ÿ ×©× ×¤×ª×—.
            </p>
        </div>

        <div class="step">
            <div class="step-num">3</div>
            <strong>×—×™×‘×•×¨</strong>
            ×œ×—×¥ ×¢×œ ×”×‘×•×˜ ×‘××•×¢×“×¤×™× ×‘×—×œ×•×Ÿ ×”××¤×”. ×•×•×“× ×©×›×ª×•×‘ ×œ××˜×” "××—×•×‘×¨".
        </div>
    </div>

    <div style="flex: 1; padding: 30px; overflow-y: auto;">
        <h1>××¢×¨×›×ª ××©×•×œ×‘×ª (GovMap + ×¡×˜×˜×™×¡×˜×™×§×”)</h1>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label style="font-weight:bold;">×”×–×Ÿ ×›×ª×•×‘×•×ª:</label>
            <textarea id="addressInput" style="width:100%; height:100px; margin:10px 0; padding:10px; border:1px solid #ccc;" placeholder="×”×¨×¦×œ, 15, ×ª×œ ××‘×™×‘&#10;×–'×‘×•×˜×™× ×¡×§×™, 2, ×‘× ×™ ×‘×¨×§"></textarea>
            <button onclick="loadAddresses()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">×˜×¢×Ÿ ×•×—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×”</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>×›×ª×•×‘×ª</th>
                    <th>×¢×™×¨ (××–×•×”×”)</th>
                    <th>×¦×¤×™ × ×¤×©×•×ª (×˜×•×•×—)</th>
                    <th>×¡×˜×˜×•×¡ GovMap</th>
                    <th>××™×“×¢ ×©× ×©×œ×£</th>
                    <th>×¤×¢×•×œ×”</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <br>
        <button id="exportBtn" onclick="exportToCSV()" style="background:#17a2b8; color:white; border:none; padding:10px 20px; display:none; border-radius:4px; cursor:pointer;">×”×•×¨×“ ××§×¡×œ (×¢× ×¡×™×›×•×)</button>
    </div>

    <div id="connection-status">ğŸ”´ ×× ×•×ª×§</div>

    <script>
        // === ×œ×•×’×™×§×” ××”×¤×™×™×ª×•×Ÿ: × ×ª×•× ×™ ××•×›×œ×•×¡×™×™×” ===
        const CITY_STATS = {
            "×™×¨×•×©×œ×™×": 3.8, "×ª×œ ××‘×™×‘ - ×™×¤×•": 2.2, "×—×™×¤×”": 2.4, "×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ": 2.9,
            "×¤×ª×— ×ª×§×•×•×”": 3.0, "××©×“×•×“": 3.2, "× ×ª× ×™×”": 3.0, "×‘××¨ ×©×‘×¢": 2.9,
            "×‘× ×™ ×‘×¨×§": 4.8, "×—×•×œ×•×Ÿ": 2.8, "×¨××ª ×’×Ÿ": 2.3, "×¨×—×•×‘×•×ª": 2.9,
            "××©×§×œ×•×Ÿ": 3.0, "×‘×ª ×™×": 2.6, "×‘×™×ª ×©××©": 4.6, "×›×¤×¨ ×¡×‘×": 3.0,
            "×”×¨×¦×œ×™×”": 2.8, "×—×“×¨×”": 2.9, "××•×“×™×¢×™×Ÿ ××›×‘×™× ×¨×¢×•×ª": 3.4, "× ×¦×¨×ª": 3.9,
            "×œ×•×“": 3.5, "×¨××œ×”": 3.4, "×¨×¢× × ×”": 3.1, "××•×“×™×¢×™×Ÿ ×¢×™×œ×™×ª": 6.2,
            "×‘×™×ª×¨ ×¢×™×œ×™×ª": 5.8, "×”×•×“ ×”×©×¨×•×Ÿ": 3.1, "×’×‘×¢×ª×™×™×": 2.3, "×§×¨×™×™×ª ××ª×": 2.8,
            "× ×”×¨×™×”": 2.6, "××™×œ×ª": 2.3, "×¢×›×•": 3.0, "×›×¨××™××œ": 2.7,
            "×˜×‘×¨×™×”": 2.9, "××•× ××œ ×¤×—×": 4.4, "×¨×”×˜": 5.9, "× ×ª×™×‘×•×ª": 3.9,
            "××œ×¢×“": 5.8, "×¨××© ×”×¢×™×Ÿ": 3.5, "× ×¡ ×¦×™×•× ×”": 3.0, "×§×¨×™×™×ª ××•×¦×§×™×Ÿ": 2.6,
            "×§×¨×™×™×ª ×’×ª": 3.3, "×¢×¤×•×œ×”": 2.9, "×™×‘× ×”": 3.2
        };

        function getCityStats(address) {
            // ×œ×•×’×™×§×” ×–×”×” ×œ×¤×™×™×ª×•×Ÿ ×œ×—×™×œ×•×¥ ×©× ×”×¢×™×¨
            let cityCandidate = "";
            if (address.includes(",")) {
                cityCandidate = address.split(",").pop().trim();
            } else {
                let parts = address.split(" ");
                cityCandidate = parts[parts.length - 1];
                if (parts.length >= 2) {
                    let twoWords = parts[parts.length - 2] + " " + parts[parts.length - 1];
                    for (let key in CITY_STATS) {
                        if (key.includes(twoWords.replace(',', ''))) return { city: key, avg: CITY_STATS[key] };
                    }
                }
            }

            // ×—×™×¤×•×© ×‘××™×œ×•×Ÿ
            for (let key in CITY_STATS) {
                if (cityCandidate.includes(key) || key.includes(cityCandidate.replace(',', ''))) {
                    return { city: key, avg: CITY_STATS[key] };
                }
            }
            return { city: cityCandidate, avg: 0 }; // ×‘×¨×™×¨×ª ××—×“×œ
        }

        // === ×‘×•×˜ V3 ===
        const botCode = `
            (function(){
                if(location.hostname.indexOf('govmap')===-1){alert('×¨×§ ×‘-GovMap!');return;}
                if(!window.opener){alert('××™×Ÿ ×§×©×¨ ×œ××ª×¨');return;}
                window.opener.postMessage({type:'BOT_CONNECTED'},'*');
                alert('âœ… ×‘×•×˜ ××—×•×‘×¨! ×•×•×“× ×©×”×©×›×‘×•×ª ×“×œ×•×§×•×ª.');
                
                function findInput(){
                    let i=document.getElementById('txtSearch');
                    if(!i)i=document.querySelector('input[placeholder*="×›×ª×•×‘×ª"]');
                    if(!i)i=document.querySelector('.search-input');
                    return i;
                }

                window.addEventListener('message',function(e){
                    if(e.data.type==='SEARCH_ADDRESS'){
                        let inp=findInput();
                        let btn=document.querySelector('#btnSearch')||document.querySelector('.search-btn');
                        if(inp){
                            inp.value=e.data.text;
                            inp.dispatchEvent(new Event('input',{bubbles:true}));
                            inp.dispatchEvent(new Event('change',{bubbles:true}));
                            if(btn) setTimeout(()=>btn.click(),500);
                        }
                    }
                });

                const obs=new MutationObserver(()=>{
                    let p=document.querySelector('.esri-popup__content');
                    if(p && p.innerText.length>5 && !p.dataset.scraped){
                        p.dataset.scraped="true";
                        window.opener.postMessage({type:'DATA_EXTRACTED',payload:p.innerText.replace(/\\s+/g,' ').trim()},'*');
                        let b=document.createElement('div');
                        b.innerText='âœ… × ×©×œ×—';
                        b.style.cssText='position:fixed;top:100px;right:20px;background:green;color:white;padding:10px;z-index:99999;';
                        document.body.appendChild(b);
                        setTimeout(()=>b.remove(),2000);
                    }
                });
                obs.observe(document.body,{childList:true,subtree:true});
            })();
        `;
        document.getElementById('bookmarklet-link').href = 'javascript:' + encodeURIComponent(botCode);

        // === ×œ×•×’×™×§×” ×©×œ ×”××ª×¨ ===
        let govMapWindow = null;
        let addresses = [];
        let currentProcessIndex = -1;

        function openGovMapWindow() {
            govMapWindow = window.open('https://www.govmap.gov.il/?app=dashboard', 'govmap_window');
        }

        function loadAddresses() {
            const rawText = document.getElementById('addressInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            addresses = [];

            lines.forEach((line, index) => {
                // ×©×™××•×© ×‘×œ×•×’×™×§×” ××”×¤×™×™×ª×•×Ÿ
                const stats = getCityStats(line);
                const rangeLow = stats.avg > 0 ? (stats.avg - 0.5).toFixed(1) : 0;
                const rangeHigh = stats.avg > 0 ? (stats.avg + 0.5).toFixed(1) : 0;

                const addrObj = { 
                    id: index, 
                    original: line.trim(), 
                    data: '', 
                    city: stats.city,
                    rangeLow: parseFloat(rangeLow),
                    rangeHigh: parseFloat(rangeHigh)
                };
                addresses.push(addrObj);
                
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${line}</td>
                    <td>${stats.city}</td>
                    <td>
                        <span class="pop-stats">
                            ${stats.avg > 0 ? rangeLow + ' - ' + rangeHigh : '×œ× ×™×“×•×¢'}
                        </span>
                    </td>
                    <td class="status">×××ª×™×Ÿ</td>
                    <td class="extracted-data">-</td>
                    <td><button class="action-btn" style="background:#007bff; color:white;" onclick="sendToMap(${index})">×—×¤×©</button></td>
                `;
                tbody.appendChild(tr);
            });
            if(addresses.length > 0) document.getElementById('exportBtn').style.display = 'inline-block';
        }

        function sendToMap(index) {
            if (!govMapWindow || govMapWindow.closed) {
                alert("GovMap × ×¡×’×¨!"); return;
            }
            currentProcessIndex = index;
            const address = addresses[index].original.replace(/,/g, ' ');
            
            document.querySelectorAll('tr').forEach(r => r.style.background = 'white');
            const row = document.getElementById(`row-${index}`);
            row.style.backgroundColor = '#fff3cd';
            row.querySelector('.status').innerText = 'â³ × ×©×œ×—...';

            govMapWindow.postMessage({type: 'SEARCH_ADDRESS', text: address}, '*');
        }

        window.addEventListener('message', (e) => {
            if (e.data.type === 'BOT_CONNECTED') {
                const status = document.getElementById('connection-status');
                status.innerText = "ğŸŸ¢ ××—×•×‘×¨";
                status.style.background = "#28a745";
                govMapWindow = e.source;
            }
            if (e.data.type === 'DATA_EXTRACTED') {
                if (currentProcessIndex === -1) return;
                const data = e.data.payload;
                const row = document.getElementById(`row-${currentProcessIndex}`);
                
                row.querySelector('.status').innerHTML = '<span class="status-done">âœ… × ×©××¨</span>';
                row.querySelector('.extracted-data').innerText = data.substring(0, 40) + '...';
                row.style.backgroundColor = '#d4edda';
                addresses[currentProcessIndex].data = data;
            }
        });

        // === ×™×™×¦×•× ×œ××§×¡×œ (×œ×•×’×™×§×” ××”×¤×™×™×ª×•×Ÿ) ===
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += "Address,City,Range Low,Range High,GovMap Data\n";
            
            let totalLow = 0;
            let totalHigh = 0;

            addresses.forEach(addr => {
                totalLow += addr.rangeLow;
                totalHigh += addr.rangeHigh;
                
                const safeData = addr.data.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";");
                const safeAddr = addr.original.replace(/,/g, " ");
                csvContent += `${safeAddr},${addr.city},${addr.rangeLow},${addr.rangeHigh},"${safeData}"\n`;
            });

            // ×©×•×¨×ª ×¡×™×›×•× ×›××• ×‘×¤×™×™×ª×•×Ÿ
            csvContent += `TOTAL,,,${totalLow.toFixed(1)},${totalHigh.toFixed(1)},SUM_ROW\n`;

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "govmap_full_analysis.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>

