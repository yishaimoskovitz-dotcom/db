<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovMap Automation Dashboard</title>
    <style>
        :root {
            --primary: #0044cc;
            --success: #28a745;
            --bg: #f4f6f9;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            height: 100vh;
        }
        /* ×¡×¨×’×œ ×¦×“ */
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .step {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .step-icon { font-size: 1.2rem; }
        
        /* ×ª×•×›×Ÿ ×¨××©×™ */
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        h1 { margin-top: 0; color: #333; }
        
        /* ××–×•×¨ ×§×œ×˜ */
        .input-area {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* ×˜×‘×œ×” */
        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        th { background: #fafafa; font-weight: 600; }
        .status-waiting { color: #999; }
        .status-done { color: var(--success); font-weight: bold; }
        
        /* ×”×•×“×¢×ª ×—×™×‘×•×¨ ×œ×ª×•×¡×£ */
        #extension-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>ğŸ“˜ ××“×¨×™×š ×œ××©×ª××©</h3>
        <div class="step">
            <span class="step-icon">1ï¸âƒ£</span> ×”×–×Ÿ ×›×ª×•×‘×•×ª ×‘×¤×•×¨××˜:<br>
            <b>×¨×—×•×‘ | ××¡×¤×¨ | ×¢×™×¨</b>
        </div>
        <div class="step">
            <span class="step-icon">2ï¸âƒ£</span> ×œ×—×¥ ×¢×œ "×˜×¢×Ÿ ×›×ª×•×‘×•×ª"
        </div>
        <div class="step">
            <span class="step-icon">3ï¸âƒ£</span> ×”××¢×¨×›×ª ×ª×¤×ª×— ××ª GovMap
        </div>
        <div class="step">
            <span class="step-icon">4ï¸âƒ£</span> <b>×‘××¤×”:</b> ×œ×—×¥ ×¢×œ ×”×¤×™×Ÿ ×•×”××ª×Ÿ ×©×”×‘×•×¢×” ×ª×™×¤×ª×—
        </div>
        <div class="step">
            <span class="step-icon">5ï¸âƒ£</span> ×¡×’×•×¨ ××ª ×”×˜××‘ ×•×—×–×•×¨ ×œ×›××Ÿ
        </div>
    </div>

    <div class="main-content">
        <h1>××¢×¨×›×ª ××•×˜×•××¦×™×” GovMap</h1>
        <p>×©×œ×•×, ×”×›×™× ×• ××ª ×”××¦×‘×¢×•×ª ğŸ‘†. ×”××¢×¨×›×ª ××•×›× ×” ×œ×¢×‘×•×“×”.</p>

        <div class="input-area">
            <label>×”×–×Ÿ ×¨×©×™××ª ×›×ª×•×‘×•×ª (×›×œ ×›×ª×•×‘×ª ×‘×©×•×¨×” ×—×“×©×”):</label>
            <textarea id="addressInput" placeholder="×”×¨×¦×œ | 15 | ×ª×œ ××‘×™×‘&#10;×–'×‘×•×˜×™× ×¡×§×™ | 2 | ×¨××ª ×’×Ÿ"></textarea>
            <button onclick="loadAddresses()">×˜×¢×Ÿ ×›×ª×•×‘×•×ª ×œ×˜×‘×œ×”</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>×›×ª×•×‘×ª ××§×•×¨×™×ª</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>× ×ª×•× ×™× ×©× ×©×œ×¤×• (GovMap)</th>
                    <th>×¤×¢×•×œ×”</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
        
        <br>
        <button id="exportBtn" onclick="exportToCSV()" style="background:#28a745; display:none;">×”×•×¨×“ ××§×¡×œ / CSV</button>
    </div>

    <div id="extension-status">ğŸ”´ ×××ª×™×Ÿ ×œ×—×™×‘×•×¨ ×¢× ×”×ª×•×¡×£...</div>

    <script>
        let addresses = [];
        let currentProcessIndex = -1;

        // 1. ×˜×¢×™× ×ª ×”×›×ª×•×‘×•×ª ×œ×˜×‘×œ×”
        function loadAddresses() {
            const rawText = document.getElementById('addressInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            addresses = [];

            lines.forEach((line, index) => {
                // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª
                if (!line.includes('|')) {
                    alert(`×©×•×¨×” ×œ× ×ª×§×™× ×”: ${line}\n×—×™×™×‘ ×œ×”×›×™×œ ××¤×¨×™×“ "|"`);
                    return;
                }

                addresses.push({ id: index, original: line.trim(), data: '', status: 'waiting' });
                
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${line}</td>
                    <td class="status">×××ª×™×Ÿ</td>
                    <td class="extracted-data">-</td>
                    <td><button onclick="processAddress(${index})">×—×¤×©</button></td>
                `;
                tbody.appendChild(tr);
            });
            
            if (addresses.length > 0) {
                document.getElementById('exportBtn').style.display = 'inline-block';
            }
        }

        // 2. ×¤×ª×™×—×ª GovMap
        function processAddress(index) {
            currentProcessIndex = index;
            const address = addresses[index].original;
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘×˜×‘×œ×”
            const row = document.getElementById(`row-${index}`);
            row.querySelector('.status').innerText = 'â³ ×‘×˜×™×¤×•×œ...';
            row.style.backgroundColor = '#fff3cd';

            // × ×™×§×•×™ ×”×¡×™×× ×™× "|" ×›×“×™ ×©-GovMap ×™×‘×™×Ÿ
            const searchString = address.replace(/\|/g, ' '); 
            
            // ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×—×“×©
            window.open(`https://www.govmap.gov.il/?q=${encodeURIComponent(searchString)}`, '_blank');
        }

        // 3. ×”××–× ×” ×œ××™×¨×•×¢ ×©××’×™×¢ ××”×ª×•×¡×£ (Connector.js)
        window.addEventListener('GOVMAP_DATA_RECEIVED', (e) => {
            const data = e.detail; // ×”××™×“×¢ ×©×”×’×™×¢ ××”×ª×•×¡×£
            console.log("×”×ª×§×‘×œ ××™×“×¢:", data);

            // ×¢×“×›×•×Ÿ ×—×™×•×•×™ ×ª×•×¡×£
            const statusDiv = document.getElementById('extension-status');
            statusDiv.innerHTML = "ğŸŸ¢ ××—×•×‘×¨ ×œ×ª×•×¡×£";
            statusDiv.style.background = "green";

            // ×× ××™×Ÿ ×ª×”×œ×™×š ×¤×¢×™×œ, ××™×Ÿ ××” ×œ×¢×“×›×Ÿ
            if (currentProcessIndex === -1) return;

            // ×¢×“×›×•×Ÿ ×”×˜×‘×œ×”
            const row = document.getElementById(`row-${currentProcessIndex}`);
            row.querySelector('.status').innerHTML = '<span class="status-done">âœ… ×”×•×©×œ×</span>';
            row.querySelector('.extracted-data').innerText = data.latestData.substring(0, 50) + '...'; // ×”×¦×¦×” ×œ××™×“×¢
            row.style.backgroundColor = '#d4edda';

            // ×©××™×¨×ª ×”××™×“×¢ ×‘××•×‘×™×™×§×˜
            addresses[currentProcessIndex].data = data.latestData;
            addresses[currentProcessIndex].status = 'done';

            // ×¡×™×•× ×ª×”×œ×™×š × ×•×›×—×™
            currentProcessIndex = -1;
            
            // ×¦×œ×™×œ ×”×¦×œ×—×” ×§×˜×Ÿ (××•×¤×¦×™×•× ×œ×™)
            new Audio('https://freesound.org/data/previews/171/171671_2437358-lq.mp3').play().catch(()=>({}));
        });

        // 4. ×™×™×¦×•× ×œ-CSV
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM ×œ×¢×‘×¨×™×ª
            csvContent += "×›×ª×•×‘×ª ××§×•×¨×™×ª,××™×“×¢ ×©× ×©×œ×£\n";
            
            addresses.forEach(addr => {
                // × ×™×§×•×™ ×¤×¡×™×§×™× ×›×“×™ ×œ× ×œ×©×‘×•×¨ ××ª ×”-CSV
                const safeData = addr.data.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";");
                csvContent += `${addr.original},"${safeData}"\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "govmap_data.csv");
            document.body.appendChild(link);
            link.click();
        }

        // ×‘×“×™×§×” ×¨××©×•× ×™×ª ×©×”×§×•×“ ×¨×¥
        console.log("Dashboard Loaded");
    </script>
</body>
</html>