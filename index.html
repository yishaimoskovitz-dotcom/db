<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GovMap Automation Dashboard</title>
    <style>
        :root { --primary: #0044cc; --success: #28a745; --bg: #f4f6f9; --warning: #ffc107; --danger: #dc3545; }
        body { font-family: system-ui, -apple-system, sans-serif; background-color: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 280px; background: white; padding: 20px; border-left: 1px solid #ddd; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .step { padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 0.9rem; border: 1px solid #eee; }
        .step strong { display: block; margin-bottom: 5px; color: var(--primary); }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; }
        .input-area { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        /* ×›×¤×ª×•×¨ ×”×‘×•×˜ ×”××™×•×—×“ */
        #bookmarklet-link {
            display: block;
            background: #6f42c1;
            color: white;
            text-decoration: none;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            border: 2px dashed #bba1ea;
            cursor: move; /* ×¡××Ÿ ×’×¨×™×¨×” */
        }
        #bookmarklet-link:hover { background: #5a32a3; }

        table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #fafafa; font-weight: 600; }
        .status-done { color: var(--success); font-weight: bold; }
        #connection-status { position: fixed; bottom: 10px; left: 10px; background: #dc3545; color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>ğŸ“˜ ×”×•×¨××•×ª ×”×¤×¢×œ×”</h3>
        
        <div class="step" style="border-color: #6f42c1; background: #f3eafa;">
            <strong>1ï¸âƒ£ ×”×ª×§× ×” ×—×“-×¤×¢××™×ª</strong>
            ×’×¨×•×¨ ××ª ×”×›×¤×ª×•×¨ ×”×¡×’×•×œ ×œ××˜×” ××œ ×¡×¨×’×œ ×”×¡×™×× ×™×•×ª ×©×œ×š ×‘×“×¤×“×¤×Ÿ (Favorites Bar).
            <br><br>
            <a id="bookmarklet-link" href="#" onclick="alert('×™×© ×œ×’×¨×•×¨ ××ª ×”×›×¤×ª×•×¨ ×”×–×” ×œ×¡×¨×’×œ ×”××•×¢×“×¤×™× ×œ××¢×œ×”, ×œ× ×œ×œ×—×•×¥ ×¢×œ×™×•! ğŸ˜‰'); return false;">
                ğŸ¤– ×‘×•×˜ GovMap
            </a>
        </div>

        <div class="step">
            <strong>2ï¸âƒ£ ×¤×ª×™×—×ª ×”××¤×”</strong>
            ×œ×—×¥ ×¢×œ "×¤×ª×— GovMap" ×›××Ÿ ×‘××ª×¨.
        </div>

        <div class="step">
            <strong>3ï¸âƒ£ ×”×¤×¢×œ×ª ×”×‘×•×˜</strong>
            ×‘×—×œ×•×Ÿ ×”×—×“×© ×©×œ GovMap ×©× ×¤×ª×—, ×œ×—×¥ ×¢×œ ×”×‘×•×˜ ×©×’×¨×¨×ª ×œ××•×¢×“×¤×™×. ×ª×¨××” ×”×•×“×¢×” "×‘×•×˜ ××—×•×‘×¨".
        </div>

        <div class="step">
            <strong>4ï¸âƒ£ ×¢×‘×•×“×” ×©×•×˜×¤×ª</strong>
            ×©×œ×— ×›×ª×•×‘×•×ª ××›××Ÿ -> ×”×‘×•×˜ ×™×—×¤×© -> ×œ×—×¥ ×¢×œ ×¤×™×Ÿ -> ×”××™×“×¢ ×™×—×–×•×¨ ×œ×‘×“.
        </div>
    </div>

    <div class="main-content">
        <h1>××¢×¨×›×ª ××•×˜×•××¦×™×” GovMap (×œ×œ× ×”×ª×§× ×”)</h1>
        
        <div class="input-area">
            <button onclick="openGovMapWindow()" style="background: #28a745; margin-bottom: 15px;">ğŸŒ ×¤×ª×— ×—×œ×•×Ÿ GovMap ×œ×¢×‘×•×“×”</button>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <label>×”×–×Ÿ ×¨×©×™××ª ×›×ª×•×‘×•×ª (×¨×—×•×‘, ××¡×¤×¨, ×¢×™×¨):</label>
            <textarea id="addressInput" placeholder="×”×¨×¦×œ, 15, ×ª×œ ××‘×™×‘&#10;×–'×‘×•×˜×™× ×¡×§×™, 2, ×¨××ª ×’×Ÿ"></textarea>
            <button onclick="loadAddresses()">×˜×¢×Ÿ ×›×ª×•×‘×•×ª ×œ×˜×‘×œ×”</button>
        </div>

        <table id="resultsTable">
            <thead>
                <tr><th>#</th><th>×›×ª×•×‘×ª</th><th>×¡×˜×˜×•×¡</th><th>××™×“×¢ ×©× ×©×œ×£</th><th>×¤×¢×•×œ×”</th></tr>
            </thead>
            <tbody></tbody>
        </table>
        <br>
        <button id="exportBtn" onclick="exportToCSV()" style="background:#17a2b8; display:none;">×”×•×¨×“ ××§×¡×œ / CSV</button>
    </div>

    <div id="connection-status">ğŸ”´ ×× ×•×ª×§ ×-GovMap</div>

    <script>
        // --- ×™×¦×™×¨×ª ×§×•×“ ×”×‘×•×˜ (Bookmarklet) ---
        // ×–×” ×”×§×•×“ ×©×™×¨×•×¥ ×‘×ª×•×š GovMap ×›×©×ª×œ×—×¥ ×¢×œ ×”××•×¢×“×¤×™×
        const botCode = `
            (function(){
                if(!window.opener) { alert('×©×’×™××”: ×™×© ×œ×¤×ª×•×— ××ª GovMap ×“×¨×š ×”×“××©×‘×•×¨×“ ×‘×œ×‘×“!'); return; }
                
                alert('ğŸ¤– ×”×‘×•×˜ ×—×•×‘×¨ ×‘×”×¦×œ×—×” ×œ×“××©×‘×•×¨×“!');
                window.opener.postMessage({type: 'BOT_CONNECTED'}, '*');

                // 1. ×”××–× ×” ×œ×¤×§×•×“×•×ª ××”×“××©×‘×•×¨×“
                window.addEventListener('message', function(e) {
                    if(e.data.type === 'SEARCH_ADDRESS') {
                        const address = e.data.text;
                        const input = document.getElementById('txtSearch') || document.querySelector('input[type="text"]');
                        const btn = document.querySelector('.search-btn') || document.querySelector('#btnSearch');
                        
                        if(input && btn) {
                            input.value = address;
                            input.dispatchEvent(new Event('input', {bubbles:true}));
                            input.dispatchEvent(new Event('change', {bubbles:true}));
                            setTimeout(() => btn.click(), 500);
                        }
                    }
                });

                // 2. ×¦×™×™×“ ×”×‘×•×¢×•×ª (Scraper)
                const observer = new MutationObserver(() => {
                    const popup = document.querySelector('.esri-popup__content');
                    if(popup && popup.innerText.length > 10 && !popup.dataset.scraped) {
                        popup.dataset.scraped = "true";
                        const cleanText = popup.innerText.replace(/\\s+/g, ' ').trim();
                        
                        // ×©×œ×™×—×” ×—×–×¨×” ×œ×“××©×‘×•×¨×“
                        window.opener.postMessage({type: 'DATA_EXTRACTED', payload: cleanText}, '*');
                        
                        // ×—×™×•×•×™ ×•×™×–×•××œ×™ ×‘××¤×”
                        const badge = document.createElement('div');
                        badge.innerText = 'âœ… × ×©×œ×— ×œ×“××©×‘×•×¨×“';
                        badge.style.cssText = 'position:fixed; top:80px; right:10px; background:#28a745; color:white; padding:10px; z-index:99999; border-radius:5px; font-weight:bold; box-shadow:0 2px 10px rgba(0,0,0,0.3);';
                        document.body.appendChild(badge);
                        setTimeout(() => badge.remove(), 3000);
                    }
                });
                observer.observe(document.body, {childList: true, subtree: true});
            })();
        `;
        
        // ×§×™×“×•×“ ×”×‘×•×˜ ×œ×œ×™× ×§
        document.getElementById('bookmarklet-link').href = 'javascript:' + encodeURIComponent(botCode);

        // --- ×œ×•×’×™×§×” ×©×œ ×”×“××©×‘×•×¨×“ ---
        let govMapWindow = null;
        let addresses = [];
        let currentProcessIndex = -1;

        function openGovMapWindow() {
            govMapWindow = window.open('https://www.govmap.gov.il/?bot=true', 'govmap_worker');
        }

        function loadAddresses() {
            const rawText = document.getElementById('addressInput').value;
            const lines = rawText.split('\n').filter(line => line.trim() !== '');
            const tbody = document.querySelector('#resultsTable tbody');
            tbody.innerHTML = '';
            addresses = [];

            lines.forEach((line, index) => {
                if (!line.includes(',')) { alert(`×©×’×™××” ×‘×©×•×¨×”: ${line}`); return; }
                addresses.push({ id: index, original: line.trim(), data: '', status: 'waiting' });
                const tr = document.createElement('tr');
                tr.id = `row-${index}`;
                tr.innerHTML = `<td>${index + 1}</td><td>${line}</td><td class="status">×××ª×™×Ÿ</td><td class="extracted-data">-</td><td><button onclick="sendToMap(${index})">ğŸ“¡ ×—×¤×©</button></td>`;
                tbody.appendChild(tr);
            });
            if(addresses.length > 0) document.getElementById('exportBtn').style.display = 'inline-block';
        }

        function sendToMap(index) {
            if (!govMapWindow || govMapWindow.closed) {
                alert("×—×œ×•×Ÿ GovMap × ×¡×’×¨! ×¤×ª×— ××•×ª×• ××—×“×© ×•×”×¤×¢×œ ××ª ×”×‘×•×˜.");
                document.getElementById('connection-status').innerText = "ğŸ”´ ×× ×•×ª×§";
                document.getElementById('connection-status').style.background = "#dc3545";
                return;
            }

            currentProcessIndex = index;
            const address = addresses[index].original.replace(/,/g, ' ');

            // ×¢×“×›×•×Ÿ UI
            document.querySelectorAll('tr').forEach(r => r.style.background = 'white');
            const row = document.getElementById(`row-${index}`);
            row.style.backgroundColor = '#fff3cd';
            row.querySelector('.status').innerText = 'â³ × ×©×œ×—...';

            // ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×—×œ×•×Ÿ ×”×©× ×™
            govMapWindow.postMessage({type: 'SEARCH_ADDRESS', text: address}, '*');
        }

        // ×”××–× ×” ×œ×”×•×“×¢×•×ª ×©×—×•×–×¨×•×ª ×-GovMap
        window.addEventListener('message', (e) => {
            // 1. ×–×™×”×•×™ ×—×™×‘×•×¨ ×¨××©×•× ×™
            if (e.data.type === 'BOT_CONNECTED') {
                const status = document.getElementById('connection-status');
                status.innerText = "ğŸŸ¢ ××—×•×‘×¨ ×œ×‘×•×˜";
                status.style.background = "#28a745";
                govMapWindow = e.source; // ×©××™×¨×ª ×¨×¤×¨× ×¡ ×œ×—×œ×•×Ÿ
            }

            // 2. ×§×‘×œ×ª × ×ª×•× ×™×
            if (e.data.type === 'DATA_EXTRACTED') {
                if (currentProcessIndex === -1) return;

                const data = e.data.payload;
                const row = document.getElementById(`row-${currentProcessIndex}`);
                
                row.querySelector('.status').innerHTML = '<span class="status-done">âœ… ×”×•×©×œ×</span>';
                row.querySelector('.extracted-data').innerText = data.substring(0, 50) + '...';
                row.style.backgroundColor = '#d4edda';
                
                addresses[currentProcessIndex].data = data;
                
                new Audio('https://freesound.org/data/previews/171/171671_2437358-lq.mp3').play().catch(()=>{});
            }
        });

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF×›×ª×•×‘×ª,××™×“×¢\n";
            addresses.forEach(addr => {
                csvContent += `${addr.original.replace(/,/g, ' ')},"${addr.data.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";")}"\n`;
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "govmap_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
